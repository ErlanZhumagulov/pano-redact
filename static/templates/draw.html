<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–†–∏—Å–æ–≤–∞–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
            gap: 20px;
        }
        .toolbar {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.18);
            flex-wrap: wrap;
            width: 100%;
            max-width: 900px;
        }
        .tool-btn { padding: 10px 16px; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; font-size: 15px; font-weight: 600; }
        .tool-btn.active { background: #667eea; color: #fff; border-color: #667eea; }
        .size-control { display:flex; gap:8px; align-items:center; }
        .size-control input[type="range"] { width:120px; }

        /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–¥ —ç–∫—Ä–∞–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
        .canvas-container {
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.45);
            border-radius: 10px;
            overflow: hidden;
            background: white;
            /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —à–∏—Ä–∏–Ω–∞ –±—É–¥–µ—Ç –ø–æ–¥–≥–æ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS */
            max-width: 100%;
            touch-action: none; /* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ */
        }

        /* –¥–≤–∞ –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ö–æ–ª—Å—Ç–∞ */
        canvas {
            display: block;
            cursor: crosshair;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;   /* CSS –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–∏–∫—Å–µ–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –∞—Ç—Ä–∏–±—É—Ç–∞—Ö width/height */
            height: 100%;
            -webkit-user-select: none;
            user-select: none;
        }
        #bgCanvas { pointer-events: none; }

        .clear-btn { background: #dc3545; color: white; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }

        @media (max-width: 420px) {
            .toolbar { padding: 10px; gap: 8px; }
            .size-control input[type="range"] { width: 90px; }
        }
    </style>
</head>
<body>
<div class="toolbar" id="toolbar">
    <button class="tool-btn active" id="brushBtn" onclick="selectTool('brush')">üñåÔ∏è –ö–∏—Å—Ç—å</button>
    <button class="tool-btn" id="eraserBtn" onclick="selectTool('eraser')">üßπ –õ–∞—Å—Ç–∏–∫</button>
    <div class="size-control">
        <label>–†–∞–∑–º–µ—Ä:</label>
        <input type="range" id="sizeSlider" min="1" max="100" value="5">
        <span id="sizeValue">5</span>
    </div>
    <div class="size-control">
        <label>–¶–≤–µ—Ç:</label>
        <input type="color" id="colorPicker" value="#000000">
    </div>
    <button class="clear-btn" onclick="clearDrawing()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<div class="canvas-container" id="canvasWrap">
    <canvas id="bgCanvas"></canvas>
    <canvas id="drawCanvas"></canvas>
</div>

<script>
    // --- —ç–ª–µ–º–µ–Ω—Ç—ã ---
    const bgCanvas = document.getElementById('bgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const drawCanvas = document.getElementById('drawCanvas');
    const ctx = drawCanvas.getContext('2d');
    const wrap = document.getElementById('canvasWrap');
    const toolbar = document.getElementById('toolbar');

    // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = '{{.URL}}'; // <-- –ø–æ—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

    let drawing = false;
    let currentTool = 'brush';
    let brushSize = 5;
    let brushColor = '#000000';

    // --- UI ---
    const brushBtn = document.getElementById('brushBtn');
    const eraserBtn = document.getElementById('eraserBtn');
    const sizeSlider = document.getElementById('sizeSlider');
    const sizeValue = document.getElementById('sizeValue');
    const colorPicker = document.getElementById('colorPicker');

    function selectTool(tool) {
        currentTool = tool;
        brushBtn.classList.toggle('active', tool === 'brush');
        eraserBtn.classList.toggle('active', tool === 'eraser');
    }
    sizeSlider.addEventListener('input', (e) => { brushSize = +e.target.value; sizeValue.textContent = brushSize; });
    colorPicker.addEventListener('input', (e) => { brushColor = e.target.value; });

    // --- —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–∞–Ω–≤–∞—Å–æ–≤ –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–∏–∫—Å–µ–ª–∏) ---
    function fitCanvasesToImage() {
        // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–º–µ—Ä—ã —Ö–æ–ª—Å—Ç–æ–≤ (–∞—Ç—Ä–∏–±—É—Ç—ã) ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏
        bgCanvas.width = img.naturalWidth || img.width;
        bgCanvas.height = img.naturalHeight || img.height;
        drawCanvas.width = bgCanvas.width;
        drawCanvas.height = bgCanvas.height;

        // —Ä–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –Ω–∏–∂–Ω–∏–π —Ö–æ–ª—Å—Ç –≤ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
        bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
        bgCtx.drawImage(img, 0, 0, bgCanvas.width, bgCanvas.height);

        // –æ—á–∏—â–∞–µ–º —Å–ª–æ–π —Ä–∏—Å—É–Ω–∫–∞
        ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);

        // –ø—Ä–∏–º–µ–Ω—è–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (CSS —à–∏—Ä–∏–Ω–∞/–≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
        applyResponsiveScale();
    }

    // --- –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å, —á—Ç–æ–±—ã –≤–µ—Å—å —Ä–∏—Å—É–Ω–æ–∫ –ø–æ–º–µ—â–∞–ª—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ---
    function applyResponsiveScale() {
        // –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        const padding = 40; // —É—á–∏—Ç—ã–≤–∞—Ç—å –æ—Ç—Å—Ç—É–ø—ã body
        const availableWidth = window.innerWidth - padding;
        const availableHeight = window.innerHeight - toolbar.getBoundingClientRect().height - padding;

        const imgW = bgCanvas.width;
        const imgH = bgCanvas.height;

        // –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å
        if (!imgW || !imgH) return;

        // –≤—ã—á–∏—Å–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (—É–º–µ–Ω—å—à–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        const scale = Math.min(availableWidth / imgW, availableHeight / imgH);

        // –∑–∞–¥–∞—ë–º –≤–∏–¥–∏–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (CSS-–ø–∏–∫—Å–µ–ª–∏)
        const visibleW = Math.round(imgW * scale);
        const visibleH = Math.round(imgH * scale);

        wrap.style.width = visibleW + 'px';
        wrap.style.height = visibleH + 'px';

        // –æ–±–∞ —Ö–æ–ª—Å—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ CSS –Ω–∞ 100% –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî —ç—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –≤–∏–∑—É–∞–ª—å–Ω—É—é –ø–æ–¥–≥–æ–Ω–∫—É
        // –≤–∞–∂–Ω–æ: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã width/height (–ø–∏–∫—Å–µ–ª–∏ –∫–∞–Ω–≤—ã) –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏ => –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ
    }

    // --- –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è —Å —É—á—ë—Ç–æ–º CSS-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è ---
    function getPointerPos(e) {
        const rect = drawCanvas.getBoundingClientRect();
        const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
        const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;

        // –º–∞—Å—à—Ç–∞–± –º–µ–∂–¥—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –ø–∏–∫—Å–µ–ª—è–º–∏ –∏ CSS —Ä–∞–∑–º–µ—Ä–∞–º–∏
        const scaleX = drawCanvas.width / rect.width;
        const scaleY = drawCanvas.height / rect.height;

        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function startDrawing(e) {
        e.preventDefault();
        drawing = true;
        const pos = getPointerPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
        if (!drawing) return;
        e.preventDefault();
        const pos = getPointerPos(e);

        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        if (currentTool === 'brush') {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = brushColor;
        } else {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.strokeStyle = 'rgba(0,0,0,1)';
        }

        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    }

    function stopDrawing(e) {
        drawing = false;
        ctx.beginPath();
    }

    function clearDrawing() {
        ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    }

    // —ç–∫—Å–ø–æ—Ä—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function exportCombinedPNG() {
        const exportCanvas = document.createElement('canvas');
        exportCanvas.width = bgCanvas.width;
        exportCanvas.height = bgCanvas.height;
        const exportCtx = exportCanvas.getContext('2d');
        exportCtx.drawImage(bgCanvas, 0, 0);
        exportCtx.drawImage(drawCanvas, 0, 0);
        return exportCanvas.toDataURL('image/png');
    }
    window.exportCombinedPNG = exportCombinedPNG;

    // —Å–æ–±—ã—Ç–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    drawCanvas.addEventListener('mousedown', startDrawing);
    drawCanvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', stopDrawing);

    drawCanvas.addEventListener('touchstart', startDrawing, {passive: false});
    drawCanvas.addEventListener('touchmove', draw, {passive: false});
    window.addEventListener('touchend', stopDrawing);

    // —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ / –ø–æ–≤–æ—Ä–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
    window.addEventListener('resize', () => { applyResponsiveScale(); });
    window.addEventListener('orientationchange', () => { setTimeout(applyResponsiveScale, 120); });

    // –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    img.onload = () => {
        fitCanvasesToImage();
    };

    // –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ –∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
    if (img.complete && img.naturalWidth) {
        fitCanvasesToImage();
    }

    // --- –ø–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–µ —ç–∫—Ä–∞–Ω–∞,
    // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å Math.min(..., 1) –Ω–∞ Math.min(...), —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ ‚Äî —Å–µ–π—á–∞—Å –æ–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.
</script>
</body>
</html>
